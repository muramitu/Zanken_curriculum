import random
import time
import os

# ----------------------
# Card ã‚¯ãƒ©ã‚¹
# ----------------------
class Card:
    def __init__(self, suit, value):
        self.suit = suit
        self.value_str = value

    def __str__(self):
        return f"{self.value_str}{self.suit}"

    def get_value(self):
        if self.value_str in ['J', 'Q', 'K']:
            return 10
        elif self.value_str == 'A':
            return 11
        else:
            return int(self.value_str)

    def ascii_art(self, hidden=False):
        if hidden:
            top = "â”Œâ”€â”€â”€â”€â”€â”"
            middle = "| ??? |"
            bottom = "â””â”€â”€â”€â”€â”€â”˜"
        else:
            top = "â”Œâ”€â”€â”€â”€â”€â”"
            middle = f"|{self.value_str:<2} {self.suit} |"
            bottom = "â””â”€â”€â”€â”€â”€â”˜"
        return [top, middle, bottom]

# ----------------------
# Deck ã‚¯ãƒ©ã‚¹
# ----------------------
class Deck:
    suits = ['â™ ', 'â™¥', 'â™¦', 'â™£']
    values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']

    def __init__(self):
        self.cards = [Card(s, v) for s in self.suits for v in self.values]
        random.shuffle(self.cards)

    def draw_card(self):
        return self.cards.pop()

# ----------------------
# Player ã‚¯ãƒ©ã‚¹
# ----------------------
class Player:
    def __init__(self, name="Player"):
        self.name = name
        self.hand = []

    def draw(self, deck):
        card = deck.draw_card()
        self.hand.append(card)
        return card

    def calculate_hand(self):
        total = sum(c.get_value() for c in self.hand)
        aces = sum(1 for c in self.hand if c.value_str == 'A')
        while total > 21 and aces:
            total -= 10
            aces -= 1
        return total

    def show_hand(self, reveal_all=True):
        cards_to_show = []
        if reveal_all:
            cards_to_show = self.hand
            hidden_flags = [False]*len(self.hand)
        else:
            cards_to_show = self.hand
            hidden_flags = [False] + [True]*(len(self.hand)-1)

        rows = ["", "", ""]
        for card, hidden in zip(cards_to_show, hidden_flags):
            art = card.ascii_art(hidden)
            for i in range(3):
                rows[i] += art[i] + " "
        return "\n".join(rows)

# ----------------------
# Dealer ã‚¯ãƒ©ã‚¹
# ----------------------
class Dealer(Player):
    def __init__(self):
        super().__init__("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼")

    def play_turn(self, deck):
        print("\n=== ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ ===")
        while self.calculate_hand() < 17:
            print("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯ãƒ’ãƒƒãƒˆï¼")
            time.sleep(0.8)
            card = self.draw(deck)
            self.animate_card_draw(card)
            print(f"\nãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®æ‰‹æœ­:\n{self.show_hand(reveal_all=True)}")
            print(f"(åˆè¨ˆ: {self.calculate_hand()})\n")
            time.sleep(0.8)
        if self.calculate_hand() >= 17:
            print("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯ã‚¹ã‚¿ãƒ³ãƒ‰ã—ã¾ã—ãŸã€‚")
            time.sleep(0.8)

    def animate_card_draw(self, card):
        art = card.ascii_art()
        for i in range(3):
            print(art[i])
            time.sleep(0.1)

# ----------------------
# Game ã‚¯ãƒ©ã‚¹
# ----------------------
class Game:
    def __init__(self):
        self.deck = Deck()
        self.player = Player("ã‚ãªãŸ")
        self.dealer = Dealer()
        self.player_score = 0
        self.dealer_score = 0
        self.tie_count = 0

    def play(self):
        for _ in range(2):
            self.player.draw(self.deck)
            self.dealer.draw(self.deck)

        print("\n=== ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ ===")
        while True:
            self.clear_screen()
            print(f"\nã‚ãªãŸã®æ‰‹æœ­:\n{self.player.show_hand()} (åˆè¨ˆ: {self.player.calculate_hand()})")
            print(f"ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®å…¬é–‹ã‚«ãƒ¼ãƒ‰:\n{self.dealer.show_hand(reveal_all=False)}")

            if self.player.calculate_hand() == 21:
                self.announce_winner("ã‚ãªãŸ")
                return
            elif self.player.calculate_hand() > 21:
                self.announce_winner("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼")
                return

            action = input("ãƒ’ãƒƒãƒˆ(h) ã‹ ã‚¹ã‚¿ãƒ³ãƒ‰(s) ã‚’é¸ã‚“ã§ãã ã•ã„: ").lower()
            if action == 'h':
                card = self.player.draw(self.deck)
                print("ã‚ãªãŸã¯ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã—ãŸ:")
                self.animate_card_draw(card)
                time.sleep(0.5)
            elif action == 's':
                break
            else:
                print("ç„¡åŠ¹ãªå…¥åŠ›ã§ã™ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
                time.sleep(1)

        print(f"\nãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®æ‰‹æœ­:\n{self.dealer.show_hand(reveal_all=True)} (åˆè¨ˆ: {self.dealer.calculate_hand()})")
        self.dealer.play_turn(self.deck)
        self.determine_winner()

    def animate_card_draw(self, card):
        art = card.ascii_art()
        for line in art:
            print(line)
            time.sleep(0.1)

    def determine_winner(self):
        player_total = self.player.calculate_hand()
        dealer_total = self.dealer.calculate_hand()
        print(f"\n==============================")
        print(f"æœ€çµ‚çµæœ: ã‚ãªãŸ {player_total} - ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ {dealer_total}")
        if dealer_total > 21 or (player_total <= 21 and player_total > dealer_total):
            self.announce_winner("ã‚ãªãŸ")
        elif player_total > 21 or player_total < dealer_total:
            self.announce_winner("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼")
        else:
            self.announce_winner("å¼•ãåˆ†ã‘")

    def announce_winner(self, winner):
        print("\n" + "="*30)
        if winner == "å¼•ãåˆ†ã‘":
            print("ã€€ã€€ã€€å¼•ãåˆ†ã‘ã§ã™ï¼")
            self.tie_count += 1
        elif winner == "ã‚ãªãŸ":
            print("ã€€ã€€ã€€ã‚ãªãŸã®å‹åˆ©ã§ã™ï¼ğŸ‰")
            self.player_score += 1
        else:
            print("ã€€ã€€ã€€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®å‹åˆ©ã§ã™ï¼ğŸ’€")
            self.dealer_score += 1
        print("="*30)
        print(f"ã‚¹ã‚³ã‚¢: ã‚ãªãŸ {self.player_score} - {self.dealer_score} ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼, å¼•ãåˆ†ã‘ {self.tie_count}\n")
        time.sleep(1.5)

    def play_again(self):
        again = input("\nã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã‹ï¼Ÿ (y/n): ").lower()
        return again == 'y'

    def clear_screen(self):
        os.system('cls' if os.name == 'nt' else 'clear')

# ----------------------
# ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
# ----------------------
def main():
    print("=== CUIãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ã¸ã‚ˆã†ã“ãï¼ ===\n")
    game = Game()
    while True:
        game.play()
        if not game.play_again():
            print("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
            break

if __name__ == "__main__":
    main()
